# Chapter 20 Readable Passwords (읽을 수 있는 비밀번호)

## 목표 - 비밀번호를 복구하거나 재설정하기
어떤 어플리케이션이든 비밀번호가 있고 유저들은 자신의 비밀번호를 잊어버리는 것은 불변의 진리이다. 대부분의 어플리케이션에서는 비밀번호 복구나 재설정하는 이메일을 발송하여 이런 문제를 해결한다. 이 방법은 유저 프로필에 이메일이 등록되어있는 경우 사용할 수 있다.

## 안티패턴 - 비밀번호를 평문으로 저장하기
비밀번호 복구 기능에서 자주 발생하는 실수는 유저에게 발송되는 이메일에 해당 유저의 비밀번호를 작성하여 보내는 경우이다. 이는 데이터베이스 설계에 아주 심각한 결함이 있는 증거이며 이를 통해 인증되지 않은 사용자가 권한을 획득해 해당 어플리케이션에 접근 가능하게끔 하는 치명적인 보안 이슈를 야기시킨다.

이번 섹션에서는 비밀번호를 평문으로 저장했을시, 어떤 문제가 발생하는지 예제를 통해 살펴보고자 한다.

### 비밀번호 저장
비밀번호는 보통 `Accounts` 테이블 내 문자열 속성의 컬럼으로 저장된다.
```sql
CREATE TABLE Accounts (
  account_id SERIAL PRIMARY KEY,
  account_name VARCHAR(20) NOT NULL,
  email VARCHAR(100) NOT NULL,
  password VARCHAR(30) NOT NULL
);
```

계정을 생성할때 단순히 문자열 리터럴 형식으로 비밀번호를 추가하여 생성할 수 있다.
```sql
INSERT INTO Accounts (account_id, account_name, email, password)
  VALUES (123, 'billkarwin', 'bill@example.com', 'xyzzy');
```
이렇게 비밀번호를 평문으로 저장하는것은 보안상 위험할 뿐만 아니라 네트워크 상에서도 그대로 드러나게 된다. 공격자가 비밀번호를 추가하는 SQL 선언문을 읽을수 있다면 비밀번호 또한 그대로 드러나게 된다. 이는 비밀번호 변경이나 로그인 시 비밀번호 검증시에도 동일한 위험을 가지고 있다. 해커들은 다양한 방법으로 사용자의 비밀번호를 탈취 할 수 있게 된다.
* 어플리케이션에서 클라이언트로 전송되는 SQL 선언문이 포함된 네트워크 패킷을 탈취 할 수 있다. 이 방법은 생각보다 훨씬 쉽다. 게다가 이를 손쉽게 수행 할 수 있는 [Wireshark](https://www.wireshark.org/)와 같은 무료 소프트웨어도 존재한다.
* 데이터베이스 서버에서 SQL로그를 검색 할 수 있다. 공격자는 데이터베이스 서버 호스트에 접근을 해야하지만 접근이 가능하다면 그들은 해당 호스트에서 SQL 선언문이 담긴 로그파일을 찾을 수 있을 것이다.
* 데이터베이스 백업파일을 탈취할 수도 있다. 백업 솔루션이 안전한지는 아무도 확신 할 수 없다.

### 비밀번호 인가
이후 사용자가 로그인을 시도 할 때, 앱에서 사용자가 입력한 비밀번호를 데이터베이스에 저장된 비밀번호와 비교대조를 할 것이다. 비밀번호를 평문으로 저장했기 때문에 입력한 텍스트 그대로 검증할 것이다. SQL에서는 아래와 같이 비교 할 수 있다.
```sql
SELECT CASE WHEN password = 'opensesame' THEN 1 ELSE 0 END
  AS password_matches
FROM Accounts
WHERE account_id = 123;
```
데이터베이스에 비밀번호를 평문으로 저장해두었기 때문에 사용자의 입력값을 그대로 SQL로 작성하여 전송하게 되는데 이렇게 되면 공격자가 쉽게 탈취 할 수 있게 된다.

### 비밀번호를 이메일로 전송
비밀번호를 평문으로 저장해두었기 때문에 사용자의 비밀번호를 가져오는것은 어려운일이 아니다.
```sql
SELECT account_name, email, password
FROM Accounts
WHERE account_id = 123;
```
이런 경우 사용자가 자신의 비밀번호를 요청하는 경우 쉽게 발송할 수 있다. 아마 이런식으로 비밀번호를 전달해주는 웹사이트를 사용해본적이 있을 것이다. 하지만 사용자 비밀번호를 이메일로 발송하는것은 굉장히 보안에 취약한 행동이다. 해커가 이메일을 탈취, 로깅 및 다른 저장소에 저장할 위험성이 있기 때문이다. 이는 안전한 프로토콜을 사용하여 메일을 열람하거나 메일서버가 안전하게 관리되는 것과는 별개의 문제이다. 이메일은 기본적으로 인터넷을 경우하여 받기 때문에 어떤 형식이든 다른 사이트에서 탈취 당할수 있다.

## 어떻게 안티패턴을 구분하는가
비밀번호를 평문으로 저장하거나 양방향으로 인코딩하여 저장한 경우와 같이 어떤 방식이든 비밀번호를 알아낼 수 있다면 안티패턴이다.

## 안티패턴 사용이 정당화 되는 경우
앱에서 써드파티에 비밀번호를 제공하는 경우가 있는데 이 경우 당신의 앱이 클라이언트 역할을 한다. 이 경우 비밀번호를 반드시 읽을 수 있는 포멧으로 저장해야한다. 평문으로 저장하는 것 대신에 양방향으로 인코딩된 문자열을 저장하면 더 좋다.

식별과 인가를 구분하는 것 또한 중요하다. 식별이 사용자는 원하는 사람이면 누구나 자신을 식별 하는 것이라면 인증은 본인이 바로 그 사람임을 인증하는 것이기 때문이다. 비밀번호는 이를 위해 활용되는 가장 보편적인 방법이다.

숙련된 해커로부터 방어하기 위한 보안책을 충분히 마련하지 못했다면 신뢰할 수 있는 인가 방식보다 효과적인 식별 방식을 고안해야 한다.

모든 소프트웨어 어플리케이션이 공격에 대한 취약성을 가지고 있지도 않고 반드시 보호되야하는 민감한 정보들을 담고 있지는 않다. 예를 들면 내부망에서 몇몇의 사용자들만 알고 사용하는 앱 같은 것들이 있을 것이다. 이런 경우 단순히 동작하는 수준의 식별 및 인가 방식을 적용 할 수 있다.

여기서 주의해야 할 점은 어플리케이션은 초기에 기획한 모습에서 점점 진화하는 경향이 있다는 것이다. 인트라넷에서 사용되던 앱이 외부망에 노출되어 있다면 반드시 보안전문가의 진단을 받아야 할 것이다.

## 해결책 - 솔트 처리된 해시로 비밀번호 저장하기
이 안티패턴의 가장 핵심문제는 비밀번호를 바로 읽을수 있는 형태로 저장되어 있는 것이다. 이를 해결하는 방법은 사용자의 입력값을 비밀번호를 읽지 않고 인가 해주는 것이다.

### 해시함수 이해하기



> 이 글은 [SQL Antipatterns - by Bill Karwin](https://pragprog.com/titles/bksqla/sql-antipatterns/) 영문 원본의 Chapter20 를 요약한 글입니다. 자의적인 해석이 들어 간 것을 참고하셨으면 좋겠습니다.